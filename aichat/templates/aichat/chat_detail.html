<!DOCTYPE html>
<html data-theme="light" lang="zh">
<head>
    <title>AI聊天 - {{ session.title|default:"新会话" }} - Engineai</title>
    {% load static %}
    <script>
      const theme = localStorage.getItem('theme') || 'light';
      if (theme) document.documentElement.setAttribute('data-theme', theme);
    </script>
    <link href="{% static 'css/output.css' %}" rel="stylesheet" />
</head>
<body class="min-h-screen">
    <div class="drawer lg:drawer-open min-h-screen">
      <input id="my-drawer" type="checkbox" class="drawer-toggle" />
      <div class="drawer-content flex flex-col">
        <div class="navbar bg-base-100 shadow-lg z-50">
          <div class="navbar-start flex-1 px-2 lg:px-4">
            <a href="{% url 'aichat:chat_home' %}" class="btn btn-ghost normal-case text-xl">AI聊天</a>
          </div>
          <div class="navbar-center">
            <span class="text-lg font-semibold">{{ session.title|default:"新会话" }}</span>
          </div>
          <div class="navbar-end px-2 lg:px-4">
            <a href="/admin/" class="btn btn-ghost">管理</a>
            <span class="px-4">{{ user.username }}</span>
            <label for="my-drawer" class="btn btn-ghost btn-circle drawer-button lg:hidden">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 stroke-current" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </label>
          </div>
        </div>
        <main class="flex-1 p-8 max-w-4xl mx-auto w-full">
          <div class="chat chat-end mb-4">
            <div class="chat-bubble">欢迎使用AI聊天！选择模型开始对话。</div>
          </div>
          <div id="messages" class="mb-8 space-y-4 max-h-[60vh] overflow-y-auto">
            {% for msg in session.messages.all %}
              <div class="chat {% if msg.role == 'user' %}chat-end{% else %}chat-start{% endif %}">
                <div class="chat-image avatar">
                  <div class="w-10 rounded-full {% if msg.role == 'user' %}bg-primary text-primary-content{% else %}bg-secondary text-secondary-content{% endif %} flex items-center justify-center">
                    <span class="text-xs font-bold">{% if msg.role == 'user' %}您{% else %}AI{% endif %}</span>
                  </div>
                </div>
                <div class="chat-header">
                  {% if msg.role == 'user' %}您{% else %}AI助手{% endif %}
                  <time class="text-xs opacity-50 ml-2">{{ msg.created_at|date:"H:i" }}</time>
                </div>
                <div class="chat-bubble prose max-w-2xl">{{ msg.content|linebreaks }}</div>
                {% if msg.model %}
                  <div class="chat-footer opacity-50 text-xs">
                    使用 {{ msg.model.name }}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
          <form id="chat-form" class="flex gap-4">
            <select id="model-select" name="model_id" class="select select-bordered flex-1 max-w-xs">
              {% for model in models %}
                <option value="{{ model.id }}" {% if forloop.first %}selected{% endif %}>{{ model.name }}</option>
              {% endfor %}
            </select>
            <textarea id="message-input" name="message" class="textarea textarea-bordered flex-1 resize-none" placeholder="输入消息..." rows="2"></textarea>
            <input type="hidden" name="session_id" value="{{ session.id }}">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary">发送</button>
          </form>
        </main>
      </div>
      <div class="drawer-side">
        <label for="my-drawer" class="drawer-overlay"></label>
        <div class="menu p-4 w-80 h-full bg-base-200 text-base-content flex flex-col">
          <ul class="menu flex-grow">
            <li><a href="{% url 'aichat:chat_home' %}">会话列表</a></li>
          </ul>
          <div class="divider"></div>
          <div class="form-control border-t border-base-300 pt-4">
            <label class="label">
              <span class="label-text">主题</span>
            </label>
            <select class="select select-bordered w-full max-w-xs" onchange="const t = this.value; localStorage.setItem('theme', t); document.documentElement.setAttribute('data-theme', t);">
              <option disabled selected>选择主题</option>
              <option value="light">Light</option>
              <option value="dark">Dark</option>
              <option value="cupcake">Cupcake</option>
              <option value="retro">Retro</option>
              <option value="cyberpunk">Cyberpunk</option>
              <option value="aqua">Aqua</option>
              <option value="emerald">Emerald</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <script>
      document.getElementById('chat-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const messageInput = document.getElementById('message-input');
        const modelSelect = document.getElementById('model-select');
        const messagesDiv = document.getElementById('messages');
        const sessionId = formData.get('session_id');
        const message = messageInput.value.trim();
        if (!message) return;

        // Add user message immediately
        const userDiv = document.createElement('div');
        userDiv.className = 'chat chat-end';
        userDiv.innerHTML = `<div class="chat-bubble">${message}</div>`;
        messagesDiv.appendChild(userDiv);
        messageInput.value = '';
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // Add assistant loading
        const assistantDiv = document.createElement('div');
        assistantDiv.className = 'chat chat-start';
        assistantDiv.innerHTML = `<div class="chat-bubble loading">AI 正在思考...</div>`;
        messagesDiv.appendChild(assistantDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        try {
          const response = await fetch('{% url "aichat:chat_api" %}', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
          });
          const data = await response.json();
          if (data.error) throw new Error(data.error);
          // Replace assistant message
          assistantDiv.innerHTML = `<div class="chat-bubble">${data.response}</div>`;
        } catch (error) {
          assistantDiv.innerHTML = `<div class="chat-bubble text-error">发送失败: ${error.message}</div>`;
        }
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    </script>
</body>
</html>